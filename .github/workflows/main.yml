name: SynapseOS Buildbot

# Контроль событий при которых будет сборка
on:
  # В нашем случае это push в ветку master
  push:
    tags:
        - "v*"
    branches: [ "master" ]
  #pull_request:
  #  tags:
  #      - "v*"
  #  branches: [ "master" ]
  # Позволяет запускать этот рабочий процесс вручную на вкладке Actions
  workflow_dispatch:

# Выполнение рабочего процесса состоит из одного или нескольких заданий, которые могут выполняться последовательно или параллельно
jobs:
  build:
    #  Все будет работать на последней версии Ubuntu
    runs-on: ubuntu-latest

    # Шаги представляют собой последовательность задач, которые будут выполняться как часть задания
    steps:
      - uses: actions/checkout@v3

      # Установка зависимостей
      - name: Installing
        run: |
          sudo apt install python3 build-essential xorriso grub-pc-bin mtools llvm lld fasm zip doxygen
          
      # Запуск сборки ядра
      - name: Building  kernel
        run: python3 build.py kernel

      # Запуск сборки ПО
      - name: Building  apps
        run: python3 build.py apps

      # Создание дистрибутива
      - name: Building  iso
        run: python3 build.py iso isol
      
      # Запуск Doxygen
      - name: Doxygen
        run: |
          sudo doxygen Doxyfile
          ls docs/doxygen/
          ls

      # Проверка релиза
      - name: Check publish
        run: |
          echo "done!"
          ls isodir/boot/
          ls
        
      # Публикация документации
      - name: Publish docs
        run: |
          git clone https://github.com/0nera/SynapseOS.git -b site
          cp -a ./docs/doxygen/html/* ./SynapseOS/
          cd ./SynapseOS/
          git config user.name SynapseOS-autobuild
          git config user.email github-actions@github.com
          git add .
          git commit -m "Deploy doxygen"
          git push

      # Публикация релиза
      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest-unstable"
          prerelease: true
          title: "Автосборка, нестабильный релиз"
          files: |
            LICENSE
            SynapseOS.iso
            SynapseOS-limine.iso
            isodir/boot/initrd.tar
            isodir/boot/kernel.elf
            docs/doxygen/rtf/refman.rtf